<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Knowledge Base Update Notification</title>
  <style>
    /* Same styling as before */
    /* ... */
  </style>
</head>
<body>
  <!-- Loading screen -->
  <div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; color: white; font-size: 20px;">
    Loading configuration...
  </div>

  <div class="notification-form" style="display: none;" id="formContainer">
    <div class="form-title">Knowledge Base Update Notification</div>
    
    <div class="form-group">
      <label for="agentName">Who is responsible for this update?</label>
      <div class="select-container">
        <select id="agentName" required>
          <option value="">-- Select an agent --</option>
          <!-- Agent options will be loaded from the server -->
        </select>
      </div>
      <span class="label-helper">Select your name from the list</span>
    </div>
    
    <div class="form-group">
      <label for="pageUrl">Link to updated page or block:</label>
      <input type="url" id="pageUrl" placeholder="https://notion.so/..." required>
      <span class="label-helper">Paste the direct link to the updated content</span>
    </div>
    
    <div class="form-group">
      <label>Send notification to:</label>
      <div class="channel-options">
        <div class="channel-option">
          <input type="checkbox" id="teamSupportUpdates" name="teams" value="support-updates" checked>
          <label for="teamSupportUpdates">Support Updates</label>
        </div>
        <div class="channel-option">
          <input type="checkbox" id="teamOutstaffSupport" name="teams" value="outstaff-support">
          <label for="teamOutstaffSupport">Outstaff Support</label>
        </div>
      </div>
      <span class="label-helper">Select where to send this notification</span>
    </div>
    
    <div class="form-group">
      <label for="updateDescription">What changed? (please provide context)</label>
      <textarea id="updateDescription" placeholder="Describe what was updated and why it's important..." required></textarea>
      <span class="label-helper">Be specific and clear about what changed and why it matters</span>
    </div>
    
    <button id="sendButton" onclick="sendNotification()">Send Notification</button>
    <div id="result"></div>
  </div>

  <!-- Error screen -->
  <div id="errorScreen" style="display: none; text-align: center; margin-top: 50px; color: #eb5757;">
    <h2>Configuration Error</h2>
    <p id="errorMessage">Unable to load configuration. Please try refreshing the page.</p>
    <button onclick="location.reload()">Refresh Page</button>
  </div>

  <script>
    // Use a bootstrapping approach to load configuration
    // This allows us to avoid hardcoding the API URL
    
    // List of possible API endpoints to try - we only need one to work
    // This list should be ordered from most preferred to least preferred
    const POSSIBLE_API_ENDPOINTS = [
      // Primary endpoint
      "https://e62db491-0255-4031-bbd8-e584bf9c4467-00-347oxjexqfcpq.janeway.replit.dev",
      // Backup endpoint if primary is unreachable
      "https://slack-sender-service.clementine-top.repl.co"
    ];
    
    // Global configuration object
    let CONFIG = {
      apiUrl: null,
      initialized: false
    };
    
    // Bootstrap the application
    function bootstrap() {
      console.log("Bootstrapping application...");
      loadConfiguration()
        .then(() => {
          // Configuration loaded successfully
          document.getElementById('loadingScreen').style.display = 'none';
          document.getElementById('formContainer').style.display = 'block';
          initializeForm();
        })
        .catch(error => {
          // Failed to load configuration
          document.getElementById('loadingScreen').style.display = 'none';
          document.getElementById('errorScreen').style.display = 'block';
          document.getElementById('errorMessage').textContent = 
            `Unable to load configuration: ${error.message}. Please contact support.`;
          console.error("Bootstrap error:", error);
        });
    }
    
    // Try to load configuration from any of the possible endpoints
    async function loadConfiguration() {
      let lastError = null;
      
      // Try each endpoint until one works
      for (const endpoint of POSSIBLE_API_ENDPOINTS) {
        try {
          console.log(`Trying endpoint: ${endpoint}`);
          // First check if the endpoint is reachable
          const response = await fetch(`${endpoint}/`, { 
            method: 'GET',
            // Use a short timeout to quickly move to next endpoint if this one is slow
            signal: AbortSignal.timeout(5000) 
          });
          
          if (response.ok) {
            // Endpoint is reachable, store it as our API URL
            CONFIG.apiUrl = endpoint;
            console.log(`Using API endpoint: ${endpoint}`);
            return;
          }
        } catch (error) {
          console.log(`Endpoint ${endpoint} failed: ${error.message}`);
          lastError = error;
          // Continue to the next endpoint
        }
      }
      
      // If we get here, all endpoints failed
      throw new Error(lastError ? lastError.message : "All API endpoints unreachable");
    }
    
    // Initialize the form
    function initializeForm() {
      console.log("Initializing form...");
      
      // Load URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const pageParam = urlParams.get('page');
      
      // Pre-fill the page URL if provided
      if (pageParam) {
        document.getElementById('pageUrl').value = decodeURIComponent(pageParam);
      }
      
      // Load agents
      loadAgents();
    }
    
    // Load agents from the server
    function loadAgents() {
      console.log("Loading agents...");
      
      const selectContainer = document.querySelector('.select-container');
      selectContainer.classList.add('select-loading');
      
      fetch(`${CONFIG.apiUrl}/agents`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (!data.agents || !Array.isArray(data.agents)) {
            throw new Error('Invalid response format');
          }
          
          const agentSelect = document.getElementById('agentName');
          
          // Clear any existing options except the first one
          while (agentSelect.options.length > 1) {
            agentSelect.remove(1);
          }
          
          // Add agent options
          data.agents.forEach(agent => {
            const option = document.createElement('option');
            option.value = agent;
            option.textContent = agent;
            agentSelect.appendChild(option);
          });
          
          console.log(`Loaded ${data.agents.length} agents`);
        })
        .catch(error => {
          console.error('Error loading agents:', error);
          showResult('Unable to load agent list. Please refresh the page or contact support.', 'error');
        })
        .finally(() => {
          // Remove loading state
          selectContainer.classList.remove('select-loading');
        });
    }
    
    function sendNotification() {
      const agentName = document.getElementById('agentName').value;
      const pageUrl = document.getElementById('pageUrl').value.trim();
      const updateDescription = document.getElementById('updateDescription').value.trim();
      const teamCheckboxes = document.querySelectorAll('input[name="teams"]:checked');
      const button = document.getElementById('sendButton');
      
      // Validate inputs
      if (!agentName) {
        showResult('Please select who is responsible for this update', 'error');
        return;
      }
      
      if (!pageUrl) {
        showResult('Please provide a link to the updated page or block', 'error');
        return;
      }
      
      if (!updateDescription) {
        showResult('Please describe what was updated', 'error');
        return;
      }
      
      if (teamCheckboxes.length === 0) {
        showResult('Please select at least one channel to notify', 'error');
        return;
      }
      
      // Collect selected teams
      const selectedTeams = Array.from(teamCheckboxes).map(cb => cb.value);
      
      // Disable button and show loading
      button.disabled = true;
      button.innerHTML = 'Sending... <span class="loading-indicator"></span>';
      
      // Prepare message data
      const messageData = {
        agentName: agentName,
        pageUrl: pageUrl,
        updateDescription: updateDescription,
        teams: selectedTeams
      };
      
      // Send the request to your service
      fetch(`${CONFIG.apiUrl}/send-to-slack`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(messageData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showResult('Update notification sent successfully!', 'success');
          // Clear form fields on success
          document.getElementById('updateDescription').value = '';
          // Don't clear agent or URL as they may be reused
        } else {
          showResult('Error: ' + (data.error || 'Failed to send notification'), 'error');
        }
      })
      .catch(error => {
        showResult('Error: ' + error.message, 'error');
        console.error('Error:', error);
      })
      .finally(() => {
        // Re-enable button
        button.disabled = false;
        button.innerHTML = 'Send Notification';
      });
    }
    
    function showResult(message, type) {
      const resultDiv = document.getElementById('result');
      resultDiv.textContent = message;
      resultDiv.className = type;
      resultDiv.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(function() {
          resultDiv.style.display = 'none';
        }, 5000);
      }
    }
    
    // Start the application
    document.addEventListener('DOMContentLoaded', bootstrap);
  </script>
</body>
</html>
